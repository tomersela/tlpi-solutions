# Code changes

I replaced System V shared memory implementation with the POSIX shared memory mechanism.<br/>
However, I kept the System V semaphores as it wasn't required by the exercise (and I wanted to keep minimal changes to the original code).

## pshm_xfr.h
```diff
--- ./svshm_xfr.h	2025-08-24 14:06:42.463902661 +0300
+++ ./pshm_xfr.h	2025-08-24 15:01:45.539069112 +0300
@@ -17,15 +17,15 @@
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <sys/sem.h>
-#include <sys/shm.h>
 #include "binary_sems.h"        /* Declares our binary semaphore functions */
 #include "tlpi_hdr.h"
 
 /* Hard-coded keys for IPC objects */
 
-#define SHM_KEY 0x1234          /* Key for shared memory segment */
 #define SEM_KEY 0x5678          /* Key for semaphore set */
 
+#define SHM_NAME "/xfr"
+
 #define OBJ_PERMS (S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP)
                                 /* Permissions for our IPC objects */

```

## pshm_xfr_writer.c
```diff
--- ./svshm_xfr_writer.c	2025-08-24 14:06:42.360028136 +0300
+++ ./pshm_xfr_writer.c	2025-08-24 15:03:21.299385466 +0300
@@ -8,12 +8,12 @@
 * the file COPYING.gpl-v3 for details.                                    *
 \*************************************************************************/
 
-/* Listing 48-2 */
+/* Solution for Exercise 54-1 */
 
-/*  svshm_xfr_writer.c
+/*  pshm_xfr_writer.c
 
-   Read buffers of data data from standard input into a System V shared memory
-   segment from which it is copied by svshm_xfr_reader.c
+   Read buffers of data data from standard input into a POSIX shared memory
+   segment from which it is copied by pshm_xfr_reader.c
 
    We use a pair of binary semaphores to ensure that the writer and reader have
    exclusive, alternating access to the shared memory. (I.e., the writer writes
@@ -30,13 +30,16 @@
         $ svshm_xfr_writer < infile &
         $ svshm_xfr_reader > out_file
 */
-#include "semun.h"              /* Definition of semun union */
-#include "svshm_xfr.h"
+#include <fcntl.h>
+#include <sys/mman.h>
+#include <unistd.h>
+
+#include "pshm_xfr.h"
 
 int
 main(int argc, char *argv[])
 {
-    int semid, shmid, bytes, xfrs;
+    int semid, shmfd, bytes, xfrs;
     struct shmseg *shmp;
     union semun dummy;
 
@@ -54,13 +57,16 @@
 
     /* Create shared memory; attach at address chosen by system */
 
-    shmid = shmget(SHM_KEY, sizeof(struct shmseg), IPC_CREAT | OBJ_PERMS);
-    if (shmid == -1)
-        errExit("shmget");
-
-    shmp = shmat(shmid, NULL, 0);
-    if (shmp == (void *) -1)
-        errExit("shmat");
+    shmfd  = shm_open(SHM_NAME, O_CREAT | O_RDWR, OBJ_PERMS);
+    if (shmfd == -1)
+        errExit("shm_open");
+
+    if (ftruncate(shmfd, sizeof(struct shmseg)) == -1)
+        errExit("ftruncate");
+
+    shmp = mmap(NULL, sizeof(struct shmseg), PROT_READ | PROT_WRITE, MAP_SHARED, shmfd, 0);
+    if (shmp == MAP_FAILED)
+        errExit("mmap");
 
     /* Transfer blocks of data from stdin to shared memory */
 
@@ -90,10 +96,10 @@
 
     if (semctl(semid, 0, IPC_RMID, dummy) == -1)
         errExit("semctl");
-    if (shmdt(shmp) == -1)
-        errExit("shmdt");
-    if (shmctl(shmid, IPC_RMID, NULL) == -1)
-        errExit("shmctl");
+    if (munmap(shmp, sizeof(struct shmseg)) == -1)
+        errExit("munmap");
+    if (shm_unlink(SHM_NAME) == -1)
+        errExit("shm_unlink");
 
     fprintf(stderr, "Sent %d bytes (%d xfrs)\n", bytes, xfrs);
     exit(EXIT_SUCCESS);
```


## pshm_xfr_reader.c
```diff
--- ./svshm_xfr_reader.c	2025-08-24 14:06:42.268099004 +0300
+++ ./pshm_xfr_reader.c	2025-08-24 15:02:45.659516841 +0300
@@ -8,19 +8,23 @@
 * the file COPYING.gpl-v3 for details.                                    *
 \*************************************************************************/
 
-/* Listing 48-3 */
+/* Solution for Exercise 54-1 */
 
-/* svshm_xfr_reader.c
+/* pshm_xfr_reader.c
 
-   Read data from a System V shared memory using a binary semaphore lock-step
-   protocol; see svshm_xfr_writer.c
+   Read data from a POSIX shared memory using a binary semaphore lock-step
+   protocol; see pshm_xfr_writer.c
 */
-#include "svshm_xfr.h"
+#include <fcntl.h>
+#include <sys/mman.h>
+
+#include "pshm_xfr.h"
 
 int
 main(int argc, char *argv[])
 {
-    int semid, shmid, xfrs, bytes;
+    int semid, shmfd, xfrs, bytes;
+    struct stat sb;
     struct shmseg *shmp;
 
     /* Get IDs for semaphore set and shared memory created by writer */
@@ -29,15 +33,18 @@
     if (semid == -1)
         errExit("semget");
 
-    shmid  = shmget(SHM_KEY, 0, 0);
-    if (shmid == -1)
+    shmfd  = shm_open(SHM_NAME, O_RDONLY, 0);
+    if (shmfd == -1)
         errExit("shmget");
 
     /* Attach shared memory read-only, as we will only read */
 
-    shmp = shmat(shmid, NULL, SHM_RDONLY);
-    if (shmp == (void *) -1)
-        errExit("shmat");
+    if (fstat(shmfd, &sb) == -1)
+        errExit("fstat");
+
+    shmp = mmap(NULL, sb.st_size, PROT_READ, MAP_SHARED, shmfd, 0);
+    if (shmp == MAP_FAILED)
+        errExit("mmap");
 
     /* Transfer blocks of data from shared memory to stdout */
 
@@ -56,8 +63,8 @@
             errExit("releaseSem");
     }
 
-    if (shmdt(shmp) == -1)
-        errExit("shmdt");
+    if (munmap(shmp, sb.st_size) == -1)
+        errExit("munmap");
 
     /* Give writer one more turn, so it can clean up */
 
```


# Testing
```
$ wc -c /etc/services
12813 /etc/services
$ ./pshm_xfr_writer < /etc/services &
[1] 13957
$ ./pshm_xfr_reader > out.txt
Received 12813 bytes (13 xfrs)
Sent 12813 bytes (13 xfrs)
[1]  + 13957 done       ./pshm_xfr_writer < /etc/services
$ wc -c ./out.txt    
12813 ./out.txt
$ 
```