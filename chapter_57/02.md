# Code changes

## us_abs_xfr.h
```diff
--- ./us_xfr.h	2025-09-01 21:58:52.603573444 +0300
+++ ./us_abs_xfr.h	2025-09-01 23:31:48.515495677 +0300
@@ -8,25 +8,19 @@
 * the file COPYING.gpl-v3 for details.                                    *
 \*************************************************************************/
 
-/* Listing 57-2 */
+/* us_abs_xfr.h
 
-/* us_xfr.h
+   Header file for us_abs_xfr_sv.c and us_abs_xfr_cl.c.
 
-   Header file for us_xfr_sv.c and us_xfr_cl.c.
-
-   These programs employ a socket in /tmp. This makes it easy to compile
-   and run the programs. However, for a security reasons, a real-world
-   application should never create sensitive files in /tmp. (As a simple of
-   example of the kind of security problems that can result, a malicious
-   user could create a file using the name defined in SV_SOCK_PATH, and
-   thereby cause a denial of service attack against this application.
-   See Section 38.7 of "The Linux Programming Interface" for more details
-   on this subject.)
+   These programs employ an abstract socket. Abstract sockets (a Linux-specific
+   feature) are similar to UNIX domain sockets, but don't have a pathname;
+   instead the socket address is distinguished by a string in an abstract
+   namespace.
 */
 #include <sys/un.h>
 #include <sys/socket.h>
 #include "tlpi_hdr.h"
 
-#define SV_SOCK_PATH "/tmp/us_xfr"
+#define SV_SOCK_PATH "\0us_abs_xfr"  /* Abstract socket (starts with null byte) */
 
 #define BUF_SIZE 100
```

## us_abs_xfr_sv.c
```diff
--- ./us_xfr_sv.c	2025-09-01 21:58:52.475999035 +0300
+++ ./us_abs_xfr_sv.c	2025-09-01 23:38:08.494087466 +0300
@@ -8,16 +8,14 @@
 * the file COPYING.gpl-v3 for details.                                    *
 \*************************************************************************/
 
-/* Listing 57-3 */
-
-/* us_xfr_sv.c
+/* us_abs_xfr_sv.c
 
    An example UNIX stream socket server. Accepts incoming connections
    and copies data sent from clients to stdout.
 
-   See also us_xfr_cl.c.
+   See also us_abs_xfr_cl.c.
 */
-#include "us_xfr.h"
+#include "us_abs_xfr.h"
 #define BACKLOG 5
 
 int
@@ -35,20 +33,14 @@
     /* Construct server socket address, bind socket to it,
        and make this a listening socket */
 
-    /* For an explanation of the following check, see the errata notes for
-       pages 1168 and 1172 at http://www.man7.org/tlpi/errata/. */
-
-    if (strlen(SV_SOCK_PATH) > sizeof(addr.sun_path) - 1)
-        fatal("Server socket path too long: %s", SV_SOCK_PATH);
-
-    if (remove(SV_SOCK_PATH) == -1 && errno != ENOENT)
-        errExit("remove-%s", SV_SOCK_PATH);
-
     memset(&addr, 0, sizeof(struct sockaddr_un));
     addr.sun_family = AF_UNIX;
-    strncpy(addr.sun_path, SV_SOCK_PATH, sizeof(addr.sun_path) - 1);
+    
+    // for abstract sockets, we copy the entire path including the leading null byte
+    memcpy(addr.sun_path, SV_SOCK_PATH, sizeof(SV_SOCK_PATH));
 
-    if (bind(sfd, (struct sockaddr *) &addr, sizeof(struct sockaddr_un)) == -1)
+    if (bind(sfd, (struct sockaddr *) &addr, 
+             sizeof(addr.sun_family) + strlen(SV_SOCK_PATH + 1) + 1) == -1)
         errExit("bind");
 
     if (listen(sfd, BACKLOG) == -1)
```

## us_abs_xfr_cl.c
```diff
--- ./us_xfr_cl.c	2025-09-01 21:58:52.363561960 +0300
+++ ./us_abs_xfr_cl.c	2025-09-01 23:38:14.739116821 +0300
@@ -8,16 +8,14 @@
 * the file COPYING.gpl-v3 for details.                                    *
 \*************************************************************************/
 
-/* Listing 57-4 */
-
-/* us_xfr_cl.c
+/* us_abs_xfr_cl.c
 
    An example UNIX domain stream socket client. This client transmits contents
    of stdin to a server socket.
 
-   See also us_xfr_sv.c.
+   See also us_abs_xfr_sv.c.
 */
-#include "us_xfr.h"
+#include "us_abs_xfr.h"
 
 int
 main(int argc, char *argv[])
@@ -35,10 +33,10 @@
 
     memset(&addr, 0, sizeof(struct sockaddr_un));
     addr.sun_family = AF_UNIX;
-    strncpy(addr.sun_path, SV_SOCK_PATH, sizeof(addr.sun_path) - 1);
+    memcpy(addr.sun_path, SV_SOCK_PATH, sizeof(SV_SOCK_PATH));
 
     if (connect(sfd, (struct sockaddr *) &addr,
-                sizeof(struct sockaddr_un)) == -1)
+                sizeof(addr.sun_family) + strlen(SV_SOCK_PATH + 1) + 1) == -1)
         errExit("connect");
 
     /* Copy stdin to socket */
```

# Testing
```
$ ./us_abs_xfr_sv > b &
[2] 6693
$ cat *.c > a
$ ./us_abs_xfr_cl < a  
$ diff a b
$ ls -l a b
-rw-r--r-- 1 debian debian 10941 Sep  1 23:38 a
-rw-r--r-- 1 debian debian 10941 Sep  1 23:38 b
$
```
