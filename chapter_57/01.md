# slow_reader.c

The program creates a socketpair with SOCK_DGRAM and forks into sender (child) and receiver (parent) processes. The sender rapidly sends 20 large messages (8KB each) filled with X's. The server receives messages with 50ms delays, creating backpressure. When the socket buffer fills up, sendto() must wait for the receiver to drain some data before it can proceed.

```C
#define _GNU_SOURCE
#include <sys/socket.h>
#include <sys/un.h>
#include <string.h>

#include "curr_time.h"
#include "tlpi_hdr.h"

#define BUF_SIZE 8192

int
main(int argc, char* argv[])
{
    int sockfd[2];
    ssize_t num_bytes;
    char buf[BUF_SIZE];

    if (socketpair(AF_UNIX, SOCK_DGRAM, 0, sockfd) == -1)
        errExit("socketpair");

    switch(fork()) {
        case -1:
            errExit("fork");

        case 0: // child
            close(sockfd[0]); // close server (parent) side
            printf("About to send message to server at %s\n", currTime("%T"));
            
            char msg[BUF_SIZE];

            for (int i = 1; i <= 20; i++) {
                // fill message with X's to use full buffer size
                snprintf(msg, sizeof(msg), "Message %d: ", i);
                int header_len = strlen(msg);
                memset(msg + header_len, 'X', BUF_SIZE - header_len - 1);
                msg[BUF_SIZE - 1] = '\0';
                printf("[Client %s] Sending message %d\n", currTime("%T"), i);
                sendto(sockfd[1], msg, strlen(msg), 0, NULL, 0);
                printf("[Client %s] Done sending message %d\n", currTime("%T"), i);
            }
            
            // send end marker
            printf("[Client %s] Sending END message\n", currTime("%T"));
            sendto(sockfd[1], "END", 3, 0, NULL, 0);
            printf("[Client %s] Done sending END message\n", currTime("%T"));
            
            close(sockfd[1]);
            break;
                
        default: // parent

            close(sockfd[1]); // close client (child) side

            while (1) {
                num_bytes = recvfrom(sockfd[0], buf, sizeof(buf) - 1, 0, NULL, 0);
                if (num_bytes > 0) {
                    buf[num_bytes] = '\0';
                    
                    // check for end marker
                    if (strcmp(buf, "END") == 0) {
                        printf("[Server %s] Received END message, stopping\n", currTime("%T"));
                        break;
                    }

                    printf("[Server %s] Received message from client (size = %ld)\n", currTime("%T"), strlen(buf));
                    usleep(50000); // 50ms - slower receiver
                }
            }

            close(sockfd[0]);
    }

    exit(EXIT_SUCCESS);
}

```

# Testing

The following output demonstrates UNIX domain datagram socket flow control and blocking behavior:

Messages 1-14 send instantly (all timestamps at 23:13:04) because the socket buffer has space.<br/>
At message 15, we see the critical blocking behavior - "Sending message 15" appears at 23:13:04, but "Done sending message 15" only appears after the server has processed several messages.<br/>
This gap proves that sendto() blocked waiting for buffer space.

After message 15 completes, messages 16-20 send quickly again because buffer space became available.<br/>
All 20 messages are received in order with no loss, proving reliability.

This behavior distinguishes UNIX domain datagram sockets from UDP sockets, which would drop packets when the receiver buffer overflows rather than blocking the sender.

```
$ ./slow_sender
About to send message to server at 23:13:04
[Client 23:13:04] **Sending message** 1
[Client 23:13:04] Done sending message 1
[Client 23:13:04] Sending message 2
[Client 23:13:04] Done sending message 2
[Client 23:13:04] Sending message 3
[Client 23:13:04] Done sending message 3
[Client 23:13:04] Sending message 4
[Client 23:13:04] Done sending message 4
[Client 23:13:04] Sending message 5
[Client 23:13:04] Done sending message 5
[Client 23:13:04] Sending message 6
[Client 23:13:04] Done sending message 6
[Client 23:13:04] Sending message 7
[Client 23:13:04] Done sending message 7
[Client 23:13:04] Sending message 8
[Client 23:13:04] Done sending message 8
[Client 23:13:04] Sending message 9
[Client 23:13:04] Done sending message 9
[Client 23:13:04] Sending message 10
[Client 23:13:04] Done sending message 10
[Client 23:13:04] Sending message 11
[Client 23:13:04] Done sending message 11
[Client 23:13:04] Sending message 12
[Client 23:13:04] Done sending message 12
[Client 23:13:04] Sending message 13
[Client 23:13:04] Done sending message 13
[Client 23:13:04] Sending message 14
[Client 23:13:04] Done sending message 14
[Client 23:13:04] Sending message 15
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Client 23:13:04] Done sending message 15
[Client 23:13:04] Sending message 16
[Client 23:13:04] Done sending message 16
[Client 23:13:04] Sending message 17
[Client 23:13:04] Done sending message 17
[Client 23:13:04] Sending message 18
[Client 23:13:04] Done sending message 18
[Client 23:13:04] Sending message 19
[Client 23:13:04] Done sending message 19
[Client 23:13:04] Sending message 20
[Client 23:13:04] Done sending message 20
[Client 23:13:04] Sending END message
[Client 23:13:04] Done sending END message
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:04] Received message from client (size = 8191)
[Server 23:13:05] Received message from client (size = 8191)
[Server 23:13:05] Received message from client (size = 8191)
[Server 23:13:05] Received message from client (size = 8191)
[Server 23:13:05] Received END message, stopping
```
