# smitty_sv2.c
```diff
--- ./smitty_sv.c	2025-10-20 04:07:05.048203667 +0300
+++ ./smitty_sv2.c	2025-10-20 04:18:20.904975508 +0300
@@ -1,7 +1,11 @@
+#define _GNU_SOURCE
 #include <signal.h>
 #include <sys/wait.h>
 #include <termios.h>
 #include <fcntl.h>
+#include <utmpx.h>
+#include <paths.h>
+#include <time.h>
 #if ! defined(__hpux)
 // HP-UX 11 doesn't have this header file
 #include <sys/select.h>
@@ -41,9 +45,40 @@
     }
 }
 
+// record login in wtmp (utmp is handled by login(1) itself)
+static void
+recordLogin(const char *line, const char *host)
+{
+    struct utmpx ut;
+
+    memset(&ut, 0, sizeof(struct utmpx));
+    ut.ut_type = LOGIN_PROCESS;
+    strncpy(ut.ut_line, line, sizeof(ut.ut_line));
+    strncpy(ut.ut_host, host, sizeof(ut.ut_host));
+    ut.ut_pid = getpid();
+    ut.ut_tv.tv_sec = time(NULL);
+
+    updwtmpx(_PATH_WTMP, &ut);
+}
+
+// record logout in wtmp
+static void
+recordLogout(const char *line)
+{
+    struct utmpx ut;
+
+    memset(&ut, 0, sizeof(struct utmpx));
+    ut.ut_type = DEAD_PROCESS;
+    strncpy(ut.ut_line, line, sizeof(ut.ut_line));
+    ut.ut_pid = getpid();
+    ut.ut_tv.tv_sec = time(NULL);
+
+    updwtmpx(_PATH_WTMP, &ut);
+}
+
 // handle a client request: copy socket input to pty and pty output to socket
 static void
-handleRequest(int cfd)
+handleRequest(int cfd, const char *remoteHost)
 {
     char slaveName[MAX_SNAME];
     fd_set inFds;
@@ -52,6 +87,7 @@
     char buf[BUF_SIZE];
     ssize_t numRead;
     struct termios tty;
+    char *line;
 
     // set up canonical terminal settings for the pty slave.
     // login will control echo/noecho as needed for password prompt
@@ -81,6 +117,11 @@
         errExit("execlp"); // if we get here, something went wrong
     }
 
+    // record login session start in wtmp
+    // extract just the pty name (e.g., "pts/3" from "/dev/pts/3")
+    line = slaveName + 5; // skip "/dev/"
+    recordLogin(line, remoteHost);
+
     // loop monitoring socket and pty master for input. if socket
     // is ready for input, relay to pty master. if pty master is ready
     // for input, relay to socket
@@ -100,6 +141,7 @@
             if (numRead <= 0) {
                 // client disconnected, kill the pty child and clean up
                 kill(childPid, SIGHUP);
+                recordLogout(line);
                 close(cfd);
                 close(masterFd);
                 exit(EXIT_SUCCESS);
@@ -122,6 +164,7 @@
                         continue; // retry
                     } else {
                         // child exited, this is permanent failure
+                        recordLogout(line);
                         close(cfd);
                         close(masterFd);
                         exit(EXIT_SUCCESS);
@@ -131,6 +174,7 @@
             }
             if (numRead == 0) {
                 // EOF: login exited
+                recordLogout(line);
                 close(cfd);
                 close(masterFd);
                 exit(EXIT_SUCCESS);
@@ -149,6 +193,7 @@
     struct sigaction sa;
     struct sockaddr_storage claddr;
     socklen_t addrlen;
+    char host[NI_MAXHOST];
 
     // establish SIGCHLD handler to reap terminated child processes
     sigemptyset(&sa.sa_mask);
@@ -175,6 +220,12 @@
             continue;
         }
 
+        // get client hostname for wtmp logging
+        if (getnameinfo((struct sockaddr *) &claddr, addrlen,
+                        host, NI_MAXHOST, NULL, 0, NI_NUMERICHOST) != 0) {
+            strncpy(host, "unknown", sizeof(host));
+        }
+
         // handle each client request in a new child process
         switch (fork()) {
         case -1:
@@ -185,7 +236,7 @@
         case 0: // child
             close(lfd); // unneeded copy of listening socket
             logClientConnection((struct sockaddr *) &claddr, addrlen);
-            handleRequest(cfd);
+            handleRequest(cfd, host);
             _exit(EXIT_SUCCESS);
 
         default: // parent
```

# Testing

Initializing the server:
```
$ sudo ./smitty_sv2                                       
Server listening on port 56789

```

From another terminal, connecting (and disconnecting right away) a few times:
```
$ ./smitty_cl 127.0.0.1 56789
tomers-debian login: %                                                                                                                  $ ./smitty_cl 127.0.0.1 56789
tomers-debian login: %                                                                                                                  $ ./smitty_cl 127.0.0.1 56789
tomers-debian login: %                                                                                                                  $ ./smitty_cl 127.0.0.1 56789
tomers-debian login: %  
```

Checking accounting logs:
```
$ cd ../chapter_40 
$ make
cc -std=c99 ...
$ sudo ./dump_utmpx /var/log/wtmp | tail -30
...
LOGIN    LOGIN_PR  (6)  1413 ttyAMA AMA0L             0   0     1413  0.0.0.0         Mon Oct 20 03:26:41 2025
tomersela USER_PR   (7)  1496 seat0      login scr   0   0        0  0.0.0.0         Mon Oct 20 03:26:46 2025
tomersela USER_PR   (7)  1496 tty2       tty2        0   0        0  0.0.0.0         Mon Oct 20 03:26:46 2025
         LOGIN_PR  (6)  9130 pts/6      127.0.0.1   0   0        0  0.0.0.0         Mon Oct 20 04:19:12 2025
         DEAD_PR   (8)  9130 pts/6                  0   0        0  0.0.0.0         Mon Oct 20 04:19:13 2025
         LOGIN_PR  (6)  9153 pts/6      127.0.0.1   0   0        0  0.0.0.0         Mon Oct 20 04:19:13 2025
         DEAD_PR   (8)  9153 pts/6                  0   0        0  0.0.0.0         Mon Oct 20 04:19:14 2025
         LOGIN_PR  (6)  9172 pts/6      127.0.0.1   0   0        0  0.0.0.0         Mon Oct 20 04:19:15 2025
         DEAD_PR   (8)  9172 pts/6                  0   0        0  0.0.0.0         Mon Oct 20 04:19:15 2025
         LOGIN_PR  (6)  9655 pts/6      127.0.0.1   0   0        0  0.0.0.0         Mon Oct 20 04:23:18 2025
         DEAD_PR   (8)  9655 pts/6                  0   0        0  0.0.0.0         Mon Oct 20 04:23:21 2025

```
