# A

## script_mod_a.c
Added `formatTimestamp()` to build timestamp strings with `strftime()`, and `scriptClose()` registered with `atexit()` to write the end timestamp when the program exits. The start timestamp is written right after opening the typescript file.

```diff
--- ./script.c	2025-10-18 12:40:28.572296237 +0300
+++ ./script_mod_a.c	2025-10-18 13:32:20.371779842 +0300
@@ -18,6 +18,7 @@
 #include <fcntl.h>
 #include <libgen.h>
 #include <termios.h>
+#include <time.h>
 #if ! defined(__hpux)
 /* HP-UX 11 doesn't have this header file */
 #include <sys/select.h>
@@ -30,6 +31,7 @@
 #define MAX_SNAME 1000
 
 struct termios ttyOrig;
+int scriptFd;
 
 static void             /* Reset terminal mode on program exit */
 ttyReset(void)
@@ -38,15 +40,39 @@
         errExit("tcsetattr");
 }
 
+static void
+formatTimestamp(char *buf, size_t bufSize, const char *prefix)
+{
+    time_t t;
+    struct tm *tm;
+    
+    t = time(NULL);
+    tm = localtime(&t);
+    snprintf(buf, bufSize, "%s", prefix);
+    strftime(buf + strlen(buf), bufSize - strlen(buf),
+             "%a %d %b %Y %I:%M:%S %p %Z\n", tm);
+}
+
+static void
+scriptClose(void)
+{
+    char buf[200];
+    
+    formatTimestamp(buf, sizeof(buf), "Script done on ");
+    write(scriptFd, buf, strlen(buf));
+    close(scriptFd);
+}
+
 int
 main(int argc, char *argv[])
 {
     char slaveName[MAX_SNAME];
     char *shell;
-    int masterFd, scriptFd;
+    int masterFd;
     struct winsize ws;
     fd_set inFds;
     char buf[BUF_SIZE];
+    char timestampBuf[200];
     ssize_t numRead;
     pid_t childPid;
 
@@ -87,6 +113,12 @@
     if (scriptFd == -1)
         errExit("open typescript");
 
+    formatTimestamp(timestampBuf, sizeof(timestampBuf), "Script started on ");
+    write(scriptFd, timestampBuf, strlen(timestampBuf));
+
+    if (atexit(scriptClose) != 0)
+        errExit("atexit");
+
     /* Place terminal in raw mode so that we can pass all terminal
      input to the pseudoterminal master untouched */
 

```

## Testing
I ran `script_mod_a`, than executed `ls -l` and exit.
```
$ ./script_mod_a
$ ls -l
total 360
-rw-rw-r-- 1 tomersela tomersela   698 Oct 18 12:38 01.md
-rw-rw-r-- 1 tomersela tomersela  4716 Oct 18 22:36 02.md
-rw-r--r-- 1 tomersela tomersela   418 Oct 18 13:31 Makefile
-rw-r--r-- 1 tomersela tomersela  4387 Oct 18 12:40 pty_fork.c
-rw-r--r-- 1 tomersela tomersela  1021 Oct 18 12:40 pty_fork.h
-rw-rw-r-- 1 tomersela tomersela  9072 Oct 18 13:32 pty_fork.o
-rw-r--r-- 1 tomersela tomersela  2873 Oct 18 12:46 pty_master_open.c
-rw-r--r-- 1 tomersela tomersela   933 Oct 18 12:46 pty_master_open.h
-rw-rw-r-- 1 tomersela tomersela  5736 Oct 18 13:32 pty_master_open.o
-rwxrwxr-x 1 tomersela tomersela 85352 Oct 18 13:32 script
-rw-r--r-- 1 tomersela tomersela  4388 Oct 18 12:40 script.c
-rwxrwxr-x 1 tomersela tomersela 86520 Oct 18 13:32 script_mod_a
-rw-r--r-- 1 tomersela tomersela  5123 Oct 18 13:32 script_mod_a.c
-rwxrwxr-x 1 tomersela tomersela 88984 Oct 18 13:57 script_mod_b
-rw-r--r-- 1 tomersela tomersela  6662 Oct 18 13:56 script_mod_b.c
-rw-r--r-- 1 tomersela tomersela  3141 Oct 18 12:42 tty_functions.c
-rw-r--r-- 1 tomersela tomersela   967 Oct 18 12:42 tty_functions.h
-rw-rw-r-- 1 tomersela tomersela  5472 Oct 18 13:32 tty_functions.o
-rw-rw-r-- 1 tomersela tomersela    59 Oct 18 23:06 typescript
$ exit
```

The session was logged into the `typescript` file:
```
$ cat typescript 
Script started on Sat 18 Oct 2025 11:06:00 PM IDT
$ ls -l
total 360
-rw-rw-r-- 1 tomersela tomersela   698 Oct 18 12:38 01.md
-rw-rw-r-- 1 tomersela tomersela  4716 Oct 18 22:36 02.md
-rw-r--r-- 1 tomersela tomersela   418 Oct 18 13:31 Makefile
-rw-r--r-- 1 tomersela tomersela  4387 Oct 18 12:40 pty_fork.c
-rw-r--r-- 1 tomersela tomersela  1021 Oct 18 12:40 pty_fork.h
-rw-rw-r-- 1 tomersela tomersela  9072 Oct 18 13:32 pty_fork.o
-rw-r--r-- 1 tomersela tomersela  2873 Oct 18 12:46 pty_master_open.c
-rw-r--r-- 1 tomersela tomersela   933 Oct 18 12:46 pty_master_open.h
-rw-rw-r-- 1 tomersela tomersela  5736 Oct 18 13:32 pty_master_open.o
-rwxrwxr-x 1 tomersela tomersela 85352 Oct 18 13:32 script
-rw-r--r-- 1 tomersela tomersela  4388 Oct 18 12:40 script.c
-rwxrwxr-x 1 tomersela tomersela 86520 Oct 18 13:32 script_mod_a
-rw-r--r-- 1 tomersela tomersela  5123 Oct 18 13:32 script_mod_a.c
-rwxrwxr-x 1 tomersela tomersela 88984 Oct 18 13:57 script_mod_b
-rw-r--r-- 1 tomersela tomersela  6662 Oct 18 13:56 script_mod_b.c
-rw-r--r-- 1 tomersela tomersela  3141 Oct 18 12:42 tty_functions.c
-rw-r--r-- 1 tomersela tomersela   967 Oct 18 12:42 tty_functions.h
-rw-rw-r-- 1 tomersela tomersela  5472 Oct 18 13:32 tty_functions.o
-rw-rw-r-- 1 tomersela tomersela    59 Oct 18 23:06 typescript
$ exit
Script done on Sat 18 Oct 2025 11:06:06 PM IDT
$ 
```

# B
## script_mod_b.c
Added `sigwinchHandler()` to catch `SIGWINCH` signals when the terminal window is resized.<br/>
This program the self-pipe trick - the handler writes a byte to a pipe, which is monitored by `select()` in the main loop.<br/>
When the pipe is readable, we drain it and forward the current window size to the pty master with `ioctl()`.

```diff
--- ./script_mod_a.c	2025-10-18 13:32:20.371779842 +0300
+++ ./script_mod_b.c	2025-10-18 13:56:45.219456095 +0300
@@ -19,6 +19,7 @@
 #include <libgen.h>
 #include <termios.h>
 #include <time.h>
+#include <signal.h>
 #if ! defined(__hpux)
 /* HP-UX 11 doesn't have this header file */
 #include <sys/select.h>
@@ -32,6 +33,7 @@
 
 struct termios ttyOrig;
 int scriptFd;
+int sigwinchPipeWrite;
 
 static void             /* Reset terminal mode on program exit */
 ttyReset(void)
@@ -63,13 +65,22 @@
     close(scriptFd);
 }
 
+static void
+sigwinchHandler(int sig)
+{
+    char c = 0;
+    write(sigwinchPipeWrite, &c, 1);
+}
+
 int
 main(int argc, char *argv[])
 {
     char slaveName[MAX_SNAME];
     char *shell;
-    int masterFd;
+    int masterFd, sigwinchPipe[2];
+    int flags;
     struct winsize ws;
+    struct sigaction sa;
     fd_set inFds;
     char buf[BUF_SIZE];
     char timestampBuf[200];
@@ -119,6 +130,32 @@
     if (atexit(scriptClose) != 0)
         errExit("atexit");
 
+    // create pipe for SIGWINCH handling
+    if (pipe(sigwinchPipe) == -1)
+        errExit("pipe");
+
+    // set both pipe ends to non-blocking
+    flags = fcntl(sigwinchPipe[0], F_GETFL);
+    if (flags == -1)
+        errExit("fcntl-F_GETFL");
+    if (fcntl(sigwinchPipe[0], F_SETFL, flags | O_NONBLOCK) == -1)
+        errExit("fcntl-F_SETFL");
+
+    flags = fcntl(sigwinchPipe[1], F_GETFL);
+    if (flags == -1)
+        errExit("fcntl-F_GETFL");
+    if (fcntl(sigwinchPipe[1], F_SETFL, flags | O_NONBLOCK) == -1)
+        errExit("fcntl-F_SETFL");
+
+    sigwinchPipeWrite = sigwinchPipe[1];
+
+    // install SIGWINCH handler
+    sigemptyset(&sa.sa_mask);
+    sa.sa_flags = 0;
+    sa.sa_handler = sigwinchHandler;
+    if (sigaction(SIGWINCH, &sa, NULL) == -1)
+        errExit("sigaction");
+
     /* Place terminal in raw mode so that we can pass all terminal
      input to the pseudoterminal master untouched */
 
@@ -136,9 +173,23 @@
         FD_ZERO(&inFds);
         FD_SET(STDIN_FILENO, &inFds);
         FD_SET(masterFd, &inFds);
+        FD_SET(sigwinchPipe[0], &inFds); // subscribe to window size changes
 
-        if (select(masterFd + 1, &inFds, NULL, NULL, NULL) == -1)
+        int maxFd = (masterFd > sigwinchPipe[0]) ? masterFd : sigwinchPipe[0];
+        if (select(maxFd + 1, &inFds, NULL, NULL, NULL) == -1) {
+            if (errno == EINTR)
+                continue;
             errExit("select");
+        }
+
+        if (FD_ISSET(sigwinchPipe[0], &inFds)) {   /* SIGWINCH received */
+            char c;
+            while (read(sigwinchPipe[0], &c, 1) > 0);  // drain pipe
+
+            // forward current window size to pty
+            if (ioctl(STDIN_FILENO, TIOCGWINSZ, &ws) >= 0)
+                ioctl(masterFd, TIOCSWINSZ, &ws);
+        }
 
         if (FD_ISSET(STDIN_FILENO, &inFds)) {   /* stdin --> pty */
             numRead = read(STDIN_FILENO, buf, BUF_SIZE);
```

## Testing
```
$ ./script_mod_b
$ tput cols
80
$ tput lines
24
```

Now, after resizing the window:
```
$ tput cols
103
$ tput lines
29
```
the terminal size (number of columns and lines) has changed.

And as before, we can see the recording under `typescript`:
```
$ exit
$ cat typescript 
Script started on Sat 18 Oct 2025 11:09:48 PM IDT
$ tput cols
80
$ tput lines
24
$ tput cols
103
$ tput lines
29
$ exit
Script done on Sat 18 Oct 2025 11:10:06 PM IDT
```
