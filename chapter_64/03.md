# script_mod_3.c
```diff
--- ./script.c	2025-10-18 12:40:28.572296237 +0300
+++ ./script_mod_3.c	2025-10-19 00:25:08.641203309 +0300
@@ -18,10 +18,8 @@
 #include <fcntl.h>
 #include <libgen.h>
 #include <termios.h>
-#if ! defined(__hpux)
-/* HP-UX 11 doesn't have this header file */
-#include <sys/select.h>
-#endif
+#include <signal.h>
+#include <sys/wait.h>
 #include "pty_fork.h"           /* Declaration of ptyFork() */
 #include "tty_functions.h"      /* Declaration of ttySetRaw() */
 #include "tlpi_hdr.h"
@@ -45,10 +43,10 @@
     char *shell;
     int masterFd, scriptFd;
     struct winsize ws;
-    fd_set inFds;
     char buf[BUF_SIZE];
     ssize_t numRead;
-    pid_t childPid;
+    // three children: shell (shellPid), stdin->pty handler (readerPid), pty->stdout handler (writerPid)
+    pid_t shellPid, readerPid, writerPid, exitedPid;
 
     /* Retrieve the attributes of terminal on which we are started */
 
@@ -61,11 +59,11 @@
        pty pair. The child is connected to the pty slave and its terminal
        attributes are set to be the same as those retrieved above. */
 
-    childPid = ptyFork(&masterFd, slaveName, MAX_SNAME, &ttyOrig, &ws);
-    if (childPid == -1)
+    shellPid = ptyFork(&masterFd, slaveName, MAX_SNAME, &ttyOrig, &ws);
+    if (shellPid == -1)
         errExit("ptyFork");
 
-    if (childPid == 0) {        /* Child: execute a shell on pty slave */
+    if (shellPid == 0) {        /* Child: execute a shell on pty slave */
 
         /* If the SHELL variable is set, use its value to determine
            the shell execed in child. Otherwise use /bin/sh. */
@@ -95,20 +93,18 @@
     if (atexit(ttyReset) != 0)
         errExit("atexit");
 
-    /* Loop monitoring terminal and pty master for input. If the
-       terminal is ready for input, then read some bytes and write
-       them to the pty master. If the pty master is ready for input,
-       then read some bytes and write them to the terminal. */
-
-    for (;;) {
-        FD_ZERO(&inFds);
-        FD_SET(STDIN_FILENO, &inFds);
-        FD_SET(masterFd, &inFds);
+    /* Create two handler processes: one relays stdin to pty master,
+       the other relays pty master to stdout and typescript file */
 
-        if (select(masterFd + 1, &inFds, NULL, NULL, NULL) == -1)
-            errExit("select");
+    // fork first child: stdin -> masterFd
+    readerPid = fork();
+    if (readerPid == -1)
+        errExit("fork");
 
-        if (FD_ISSET(STDIN_FILENO, &inFds)) {   /* stdin --> pty */
+    if (readerPid == 0) {       // reader child: read from stdin, write to pty
+        close(scriptFd);        // don't need scriptFd
+
+        for (;;) {
             numRead = read(STDIN_FILENO, buf, BUF_SIZE);
             if (numRead <= 0)
                 exit(EXIT_SUCCESS);
@@ -116,8 +112,15 @@
             if (write(masterFd, buf, numRead) != numRead)
                 fatal("partial/failed write (masterFd)");
         }
+    }
 
-        if (FD_ISSET(masterFd, &inFds)) {      /* pty --> stdout+file */
+    // fork second child: masterFd -> stdout + scriptFd
+    writerPid = fork();
+    if (writerPid == -1)
+        errExit("fork");
+
+    if (writerPid == 0) {       // writer child: read from pty, write to stdout and file
+        for (;;) {
             numRead = read(masterFd, buf, BUF_SIZE);
             if (numRead <= 0)
                 exit(EXIT_SUCCESS);
@@ -128,4 +131,34 @@
                 fatal("partial/failed write (scriptFd)");
         }
     }
+
+    // parent: orchestrate termination when a handler exits
+    close(masterFd);            // parent doesn't need these
+    close(scriptFd);
+
+    // wait for first child to exit
+    exitedPid = wait(NULL);
+    if (exitedPid == -1)
+        errExit("wait");
+
+    // if shell exited first, wait for a handler to exit
+    while (exitedPid == shellPid) {
+        exitedPid = wait(NULL);
+        if (exitedPid == -1)
+            errExit("wait");
+    }
+
+    // now exitedPid is definitely a handler - handle termination
+    if (exitedPid == writerPid) {
+        // writer exited (shell closed pty), kill reader (won't exit on its own)
+        kill(readerPid, SIGTERM);
+        wait(NULL);  // killed reader
+        wait(NULL);  // shell (if not already reaped above)
+    } else {
+        // reader exited (stdin closed), let writer drain pty output naturally
+        wait(NULL);  // writer will finish draining
+        wait(NULL);  // shell
+    }
+
+    exit(EXIT_SUCCESS);
 }
```

# Testing
```
$ ./script_mod_3
$ ls -l
total 456
-rw-rw-r-- 1 tomersela tomersela   698 Oct 18 12:38 01.md
-rw-rw-r-- 1 tomersela tomersela  8532 Oct 18 23:20 02.md
-rw-r--r-- 1 tomersela tomersela   444 Oct 19 00:24 Makefile
-rw-r--r-- 1 tomersela tomersela  4387 Oct 18 12:40 pty_fork.c
-rw-r--r-- 1 tomersela tomersela  1021 Oct 18 12:40 pty_fork.h
-rw-rw-r-- 1 tomersela tomersela  9072 Oct 19 00:24 pty_fork.o
-rw-r--r-- 1 tomersela tomersela  2873 Oct 18 12:46 pty_master_open.c
-rw-r--r-- 1 tomersela tomersela   933 Oct 18 12:46 pty_master_open.h
-rw-rw-r-- 1 tomersela tomersela  5736 Oct 19 00:24 pty_master_open.o
-rwxrwxr-x 1 tomersela tomersela 85352 Oct 19 00:24 script
-rw-r--r-- 1 tomersela tomersela  4388 Oct 18 12:40 script.c
-rwxrwxr-x 1 tomersela tomersela 85288 Oct 19 00:25 script_mod_3
-rw-r--r-- 1 tomersela tomersela  5457 Oct 19 00:25 script_mod_3.c
-rwxrwxr-x 1 tomersela tomersela 86520 Oct 19 00:24 script_mod_a
-rw-r--r-- 1 tomersela tomersela  5123 Oct 18 13:32 script_mod_a.c
-rwxrwxr-x 1 tomersela tomersela 88984 Oct 19 00:24 script_mod_b
-rw-r--r-- 1 tomersela tomersela  6662 Oct 18 13:56 script_mod_b.c
-rw-r--r-- 1 tomersela tomersela  3141 Oct 18 12:42 tty_functions.c
-rw-r--r-- 1 tomersela tomersela   967 Oct 18 12:42 tty_functions.h
-rw-rw-r-- 1 tomersela tomersela  5472 Oct 19 00:24 tty_functions.o
-rw-rw-r-- 1 tomersela tomersela     9 Oct 19 00:25 typescript
$ exit
$ cat typescript
$ ls -l
total 456
-rw-rw-r-- 1 tomersela tomersela   698 Oct 18 12:38 01.md
-rw-rw-r-- 1 tomersela tomersela  8532 Oct 18 23:20 02.md
-rw-r--r-- 1 tomersela tomersela   444 Oct 19 00:24 Makefile
-rw-r--r-- 1 tomersela tomersela  4387 Oct 18 12:40 pty_fork.c
-rw-r--r-- 1 tomersela tomersela  1021 Oct 18 12:40 pty_fork.h
-rw-rw-r-- 1 tomersela tomersela  9072 Oct 19 00:24 pty_fork.o
-rw-r--r-- 1 tomersela tomersela  2873 Oct 18 12:46 pty_master_open.c
-rw-r--r-- 1 tomersela tomersela   933 Oct 18 12:46 pty_master_open.h
-rw-rw-r-- 1 tomersela tomersela  5736 Oct 19 00:24 pty_master_open.o
-rwxrwxr-x 1 tomersela tomersela 85352 Oct 19 00:24 script
-rw-r--r-- 1 tomersela tomersela  4388 Oct 18 12:40 script.c
-rwxrwxr-x 1 tomersela tomersela 85288 Oct 19 00:25 script_mod_3
-rw-r--r-- 1 tomersela tomersela  5457 Oct 19 00:25 script_mod_3.c
-rwxrwxr-x 1 tomersela tomersela 86520 Oct 19 00:24 script_mod_a
-rw-r--r-- 1 tomersela tomersela  5123 Oct 18 13:32 script_mod_a.c
-rwxrwxr-x 1 tomersela tomersela 88984 Oct 19 00:24 script_mod_b
-rw-r--r-- 1 tomersela tomersela  6662 Oct 18 13:56 script_mod_b.c
-rw-r--r-- 1 tomersela tomersela  3141 Oct 18 12:42 tty_functions.c
-rw-r--r-- 1 tomersela tomersela   967 Oct 18 12:42 tty_functions.h
-rw-rw-r-- 1 tomersela tomersela  5472 Oct 19 00:24 tty_functions.o
-rw-rw-r-- 1 tomersela tomersela     9 Oct 19 00:25 typescript
$ exit
$ 
```
